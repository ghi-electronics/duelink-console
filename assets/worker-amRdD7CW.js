!function(){"use strict";importScripts("../consumer-queue.min.js");const e=new TextDecoder,t=new TextEncoder;let a=!1,n=!1,s=!0,i=">",r="",o=null,c=!0,l=null,u=null,d=!0,w="",g=null;const p=new ConsumerQueue,v=[">","$","&"],f=7071;async function m(){A(`Port status ${n}`),[o]=await navigator.serial.getPorts();try{await o.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"})}catch(d){return postMessage({event:"ConnectFailed",message:d?.message,name:d.name,full:d}),void C(d?.message||"Unable to open port.")}if(o.addEventListener("disconnect",()=>{A("Port disconnected"),I()}),null==o?.writable)return void C("Port is not a writable.");if(null==o?.readable)return void C("Port is not a readable.");if(g=o.writable.getWriter(),u=o.readable.getReader(),l=async function(){let t,s=!0;for(c=!0;c;)try{const{value:i,done:o}=await u.read();A("Reading... Done?",o);const l=e.decode(i).replace(/\r/gm,"");if(n&&!v.includes(l.substring(-1,1))){if(r+=l,r.length>2e3)if(l.length<r.length){r=r.substring(l.length,r.length);const e=r.indexOf("\n");e>-1&&(r=r.substring(e+1,r.length)),s=!0}else r="",postMessage({event:"output",value:"Maximum output limit reached."}),s=!1;s&&!a?postMessage({event:"output",value:r}):a&&(r="")}if(w+=l,!w)continue;let d=w.indexOf("\n");for(d>-1?w.split("\n").forEach(e=>A("->",e)):A("->",w);d>-1;)t=w.substring(0,d),t&&(A("queued:",t),p.push(t)),w=w.substring(d+1),d=w.indexOf("\n");">"!==w&&"$"!==w&&"&"!==w||(A("queued:",w),p.push(w),w=""),o&&(c=!1),await N(2)}catch(d){postMessage({event:"logError",message:d?.message||"There were problems reading."});break}}(),await N(100),0!=await async function(){let e=4;for(;e>0;){await g.write(t.encode("")),A("wrote escape count: "+(4-e+1)),await N(100);let a=await E();if(A("escape result",a),a.length>=1){a=a.pop(),">"!==a&&"$"!==a||(i=a,A("mode set to",a));break}0===a.length&&await N(500),e--}if(A("synchronize : "+(4-e+1)),0===e)return await I(),0;let a=await T("");A("new line result",a),await N(500),a=await T("sel(1)"),A("sel(1) result ",a),s&&await async function(){if(!s)return;await T("echo(0)"),s=!1}();e=3;for(;e>0;){await N(100);const t=await R();if("string"==typeof t){A("version found",t),postMessage({event:"version",value:t});break}e--}return e}()){n=!0;const e=o.getInfo();postMessage({event:"connected"}),postMessage({event:"eraseall_vid_dms",value:e.usbVendorId<<16|e.usbProductId})}else postMessage({event:"ConnectFailed",message:"Unable to detect DUELink firmware.",name:"Device is busy"})}addEventListener("message",e=>{switch(A(`---- on "message", do task: ${e.data.task} ----`),e.data.task){case"clearOutput":r="";break;case"connect":m();break;case"disconnect":I();break;case"execute":!async function(e){if(await T(">"),(e=e.toLowerCase()).startsWith("mem")){const t=await T(e);postMessage({event:"memoryRegionsResult",result:t})}else await T(e);$(`Executed: &nbsp;<code>${e}</code>`)}(e.data.line);break;case"list":!async function(e){const t=await T("list");postMessage({event:"writeResult",callbackId:e,result:t}),$("Listed program code.")}(e.data.callbackId);break;case"listAll":!async function(){const e=await T("list all");postMessage({event:"listAllResult",result:e})}();break;case"memoryRegions":x();break;case"newAll":!async function(){await T("new all"),postMessage({event:"erased"}),await x()}();break;case"play":!async function(){d=!1,postMessage({event:"playing"}),await T("run"),d||(d=!0,postMessage({event:"stopped"}))}();break;case"record":!async function(e){postMessage({event:"recording",percent:0}),await T("pgmbrst()","&"),postMessage({event:"isTalking",value:!0}),e=e.replace(/\r/gm,"").replace(/\t/gm," ").split(/\n/);let t=0;for(let a of e)await N(1),0===a.trim().length&&(a=" "),A("line",`"${a}"`),await U(a+"\n"),postMessage({event:"recording",percent:++t/e.length*100});postMessage({event:"recording",percent:100}),await U("\0"),await L(),postMessage({event:"isTalking",value:!1}),postMessage({event:"recorded"}),$("Recorded "+e.length+" line(s) of code.")}(e.data.lines);break;case"region":!async function(e){await T(`region(${e})`),postMessage({event:"regionSelected",index:e})}(e.data.index);break;case"stop":!async function(){d=!0,p.cancelWait(new Error("Stop")),g.write(t.encode("")),postMessage({event:"stopped"})}();break;case"eraseall_dms_execute_msg":!async function(){const e=o.getInfo();e.usbVendorId==f&&62209==e.usbProductId?(await g.write(new Uint8Array([250,15,199])),await N(200),postMessage({event:"eraseall_status_dms",value:2})):e.usbVendorId==f&&62208==e.usbProductId&&(await g.write(t.encode("\n")),await N(400),await g.write(t.encode("reset(1)\n")),await N(100),await g.write(t.encode("reset(1)\n")),await N(700),postMessage({event:"eraseall_status_dms",value:2}))}();break;case"eraseall_dms_connect_msg":!async function(){A(`Port status ${n}`),[o]=await navigator.serial.getPorts();try{await o.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"})}catch(t){return postMessage({event:"ConnectFailed",message:t?.message,name:t.name,full:t}),void C(t?.message||"Unable to open port.")}if(o.addEventListener("disconnect",()=>{A("Port disconnected"),I()}),null==o?.writable)return void C("Port is not a writable.");if(null==o?.readable)return void C("Port is not a readable.");const e=o.getInfo();e.usbVendorId==f&&(g=o.writable.getWriter(),postMessage({event:"eraseall_vid_dms",value:e.usbVendorId<<16|e.usbProductId}));postMessage({event:"eraseall_status_dms",value:1})}();break;case"driver_connect_msg":!async function(){if(k=!1,await m(),await N(100),!n)return;await g.write(t.encode("\n")),await N(400),(await E()).pop(),await g.write(t.encode("Dver()\n")),await N(100);let e=await E();if(e.length>0){e.pop();let t=e.pop();h=t.includes("unknown identifier")?"N/A":t}if(await g.write(t.encode("Info(0)\n")),await N(100),e=await E(),e.length>0){e.pop();let t=e.pop();const a=Number(t).toString(16).toUpperCase().padStart(6,"0");y="0x"+a}await async function(){const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink.json"),t=await e.json();b=Array.isArray(t.products)?t.products:[]}();const a=function(e){if(!b)return"NA";const t=String(e).toUpperCase(),a=b.find(e=>String(e.PID).toUpperCase()===t);return a?{name:a.name??"NA",partNumber:a.partNumber??"NA"}:"NA"}(y);if("NA"===a)return;_=a.name,M=a.partNumber,P="https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/code/driver/"+M.toLowerCase()+".txt",postMessage({event:"update_driver_path_msg",value:P}),postMessage({event:"driver_ver_msg",value:h}),postMessage({event:"device_name_msg",value:_}),k=!0}();break;case"driver_connect_updadate_msg":!async function(){if(!n||!k)return;const e=P,a=await fetch(e);if(!a.ok)return;let s=(await a.text()).replace(/\r/gm,"").replace(/\t/gm," ").split(/\n/);postMessage({event:"update_driver_percent_msg",value:0}),await T("new all"),postMessage({event:"update_driver_percent_msg",value:10}),await T("pgmbrst()","&"),await N(250),postMessage({event:"update_driver_percent_msg",value:20});let i=0;for(let t of s){await N(2),0===t.trim().length&&(t=" "),A("line",`"${t}"`),await U(t+"\n"),i++;let e=Math.floor(i/s.length*70);e>70&&(e=70),e+=20,postMessage({event:"update_driver_percent_msg",value:e})}postMessage({event:"update_driver_percent_msg",value:95}),await U("\0"),await L(),await g.write(t.encode("run\n")),await N(100),await g.write(t.encode("Region(1)\n")),await N(100),await E(),await g.write(t.encode("run\n")),await N(1e3),await g.write(t.encode("$\n")),await N(250),postMessage({event:"update_driver_percent_msg",value:96}),await g.write(t.encode("# This is region 1 User\n")),await N(250),await g.write(t.encode("# Replace this with your code\n")),await N(250),postMessage({event:"update_driver_percent_msg",value:97}),await g.write(t.encode("# StatLed(200,200,10)\n")),await N(250),postMessage({event:"update_driver_percent_msg",value:99}),await g.write(t.encode(">\n")),await N(250),await E(),postMessage({event:"update_driver_percent_msg",value:100})}()}});let b=null;let h="",_="",y="",M="",k=!1,P="";async function I(){try{await async function(){c=!1,l&&(await u.cancel(),await l,l=null)}(),g&&await g.releaseLock(),u&&await u.releaseLock(),await o.close(),$("Port disconnected.")}catch(e){n&&($("There was an error while disconnecting."),C(e?.message||"Unknown error."))}finally{n=!1,postMessage({event:"disconnected"}),postMessage({event:"version",value:null})}}async function x(){a=!0;const e=await T("mem()");postMessage({event:"memoryRegionsResult",result:e}),a=!1}function E(){return new Promise(async e=>{const t=[];let a;do{a=await p.tryPop(),a?(t.push(a),A("flushed - push line:",a)):A("flushed: No line")}while(a);t.length||(w=""),A("flushed",t),e(t)})}async function R(){const e=await T("version()");for(const t of e){if(A("line",t,(t.match(/\./g)||[]).length),-1!=t.indexOf("GHI Electronics DUELink v")){return t.split(":")[0].substring(24)}}}function A(){}function C(e){postMessage({event:"logError",message:e})}function $(e){postMessage({event:"logEvent",message:e})}function L(e=null){return e||(e=i),new Promise(async t=>{const a=[];let n;do{if(n=await p.pop().catch(()=>{t(a)}),!n)break;if(a.push(n),n.startsWith("!")){A("Error:",n);break}}while(n!==e);a.length>1?a.pop():a?.[0]===e&&a.shift(),t(a)})}function N(e){return new Promise(t=>setTimeout(t,e))}async function U(e){let a=t.encode(e),n=a.length,s=0;for(;n>0;){const e=a.subarray(s,s+Math.min(10,n));await g.write(e);const t=await p.tryPop();if(t)return t;s+=10,n-=e.length,await N(1)}return null}async function T(e,a=null,n="\n"){try{postMessage({event:"isTalking",value:!0}),await E(),g.write(t.encode(e+n)),">"!==e&&"$"!==e||(i=e),await N(50);const s=await L(a||i);return s}finally{postMessage({event:"isTalking",value:!1,lastCommand:e})}}}();
