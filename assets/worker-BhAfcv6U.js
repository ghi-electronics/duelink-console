!function(){"use strict";importScripts("../consumer-queue.min.js");const e=new TextDecoder,t=new TextEncoder;let a=!1,s=!1,n=">",r="",i=null,o=!0,l=null,c=null,u=!0,p="",g=null;const d=new ConsumerQueue,w=[">","$","&"],v=7071;let m=!1;addEventListener("message",n=>{switch(E(`---- on "message", do task: ${n.data.task} ----`),n.data.task){case"clearOutput":r="";break;case"connect":T=n.data.value,async function(){E(`Port status ${s}`),await new Promise(e=>setTimeout(e,400)),[i]=await navigator.serial.getPorts();try{if(null==i)return;i.connected&&null!=i.readable&&null!=i.writable&&(i.readable.locked||i.writable.locked)&&(await I(),await new Promise(e=>setTimeout(e,1e3))),await i.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"})}catch(n){return postMessage({event:"ConnectFailed",message:n?.message,name:n.name,full:n}),void L(n?.message||"Unable to open port.")}if(i.addEventListener("disconnect",()=>{E("Port disconnected"),I()}),null==i?.writable)return void L("Port is not a writable.");if(null==i?.readable)return void L("Port is not a readable.");if(g=i.writable.getWriter(),c=i.readable.getReader(),function(){l=async function(){let t,i=!0;o=!0;for(;o;)try{const{value:n,done:l}=await c.read();E("Reading... Done?",l);const u=e.decode(n).replace(/\r/gm,"");if(s&&!w.includes(u.substring(-1,1))){if(r+=u,r.length>2e3)if(u.length<r.length){r=r.substring(u.length,r.length);const e=r.indexOf("\n");e>-1&&(r=r.substring(e+1,r.length)),i=!0}else r="",postMessage({event:"output",value:"Maximum output limit reached."}),i=!1;i&&!a?postMessage({event:"output",value:r}):a&&(r="")}if(p+=u,!p)continue;let g=p.indexOf("\n");for(g>-1?p.split("\n").forEach(e=>E("->",e)):E("->",p);g>-1;)t=p.substring(0,g),t&&(E("queued:",t),d.push(t)),p=p.substring(g+1),g=p.indexOf("\n");">"!==p&&"$"!==p&&"&"!==p||(E("queued:",p),d.push(p),p=""),l&&(o=!1),await S(2)}catch(n){postMessage({event:"logError",message:n?.message||"There were problems reading."});break}}()}(),await S(200),0!=await async function(){postMessage({event:"update_progress_percent_msg",value:5}),await g.write(t.encode("")),await S(400),await C(),postMessage({event:"update_progress_percent_msg",value:10}),await g.write(t.encode("\n")),await S(400),await C(),postMessage({event:"update_progress_percent_msg",value:15}),await g.write(t.encode("sel(1)\n")),await S(100),await C(),postMessage({event:"update_progress_percent_msg",value:20}),await g.write(t.encode("")),await S(100),await C(),postMessage({event:"update_progress_percent_msg",value:25}),await g.write(t.encode("\n")),await S(100),await C(),postMessage({event:"update_progress_percent_msg",value:30}),1!=T&&(postMessage({event:"update_progress_percent_msg",value:35}),await g.write(t.encode(`sel(${T})\n`)),await S(50),await C(),postMessage({event:"update_progress_percent_msg",value:40}),await g.write(t.encode("")),await S(50),await C(),postMessage({event:"update_progress_percent_msg",value:45}),await g.write(t.encode("\n")),await S(50),await C());postMessage({event:"update_progress_percent_msg",value:60}),postMessage({event:"update_progress_percent_msg",value:65});const e=await async function(){const e=await W("version()");for(const t of e){if(E("line",t,(t.match(/\./g)||[]).length),-1!=t.indexOf("GHI Electronics DUELink v")){return t.split(":")[0].substring(24)}}return}();if("string"==typeof e)return E("version found",e),postMessage({event:"version",value:e}),postMessage({event:"update_progress_percent_msg",value:100}),1;return postMessage({event:"update_progress_percent_msg",value:71}),await I(),0}()){await async function(e){y=!1,T=e,await g.write(t.encode("\n")),await S(400),(await C()).pop(),await g.write(t.encode("Dver()\n")),await S(100);let a=await C();if(a.length>0){a.pop();let e=a.pop();f=e.includes("unknown identifier")?"N/A":e}if(await g.write(t.encode("Info(0)\n")),await S(100),a=await C(),a.length>0){a.pop();let e=a.pop();const t=Number(e).toString(16).toUpperCase().padStart(6,"0");b="0x"+t}await async function(){if(null==_){const e=await fetch("https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/duelink.json"),t=await e.json();_=Array.isArray(t.products)?t.products:[]}}();const s=function(e){if(!_)return"NA";const t=String(e).toUpperCase(),a=_.find(e=>String(e.PID).toUpperCase()===t);return a?{name:a.name??"NA",partNumber:a.partNumber??"NA"}:"NA"}(b);if("NA"===s)return;M=s.name,h=s.partNumber,k="https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/code/driver/"+h.toLowerCase()+".txt",P="https://raw.githubusercontent.com/ghi-electronics/duelink-website/refs/heads/dev/static/code/sample/standalone/"+h.toLowerCase()+".txt",x="https://www.duelink.com/img/catalog/"+h.toLowerCase().slice(4)+"-1.webp",postMessage({event:"update_driver_path_msg",value:k}),postMessage({event:"driver_ver_msg",value:f}),postMessage({event:"device_name_msg",value:M}),postMessage({event:"sample_path_msg",value:P}),postMessage({event:"device_img_link_msg",value:x}),y=!0}(T),s=!0;const e=i.getInfo();postMessage({event:"connected"}),postMessage({event:"eraseall_vid_dms",value:e.usbVendorId<<16|e.usbProductId})}else postMessage({event:"ConnectFailed",message:"Unable to detect DUELink firmware.",name:"Device is busy"})}();break;case"disconnect":I();break;case"execute":!async function(e){if(await W(">"),(e=e.toLowerCase()).startsWith("mem")){const t=await W(e);postMessage({event:"memoryRegionsResult",result:t})}else if(e.startsWith("run")){const t=await W(e,null,"\n",100);postMessage({event:"memoryRegionsResult",result:t})}else await W(e);$(`Executed: &nbsp;<code>${e}</code>`)}(n.data.line);break;case"list":!async function(e){a=!0;const t=await W("list");postMessage({event:"writeResult",callbackId:e,result:t}),$("Listed program code."),a=!1}(n.data.callbackId);break;case"listAll":!async function(){a=!0;const e=await W("list all");postMessage({event:"listAllResult",result:e}),a=!1}();break;case"memoryRegions":R();break;case"newAll":!async function(){await W("new all"),postMessage({event:"erased"}),await R()}();break;case"play":!async function(){u=!1,postMessage({event:"playing"}),await W("run",null,"\n",-1),u||(u=!0,postMessage({event:"stopped"}))}();break;case"record":!async function(e){postMessage({event:"recording",percent:0}),await W("pgmbrst()","&"),postMessage({event:"isTalking",value:!0}),e=e.replace(/\r/gm,"").replace(/\t/gm," ").split(/\n/);let t=0;for(let a of e)await S(1),0===a.trim().length&&(a=" "),E("line",`"${a}"`),await D(a+"\n"),postMessage({event:"recording",percent:++t/e.length*100});postMessage({event:"recording",percent:100}),await D("\0"),await U(),postMessage({event:"isTalking",value:!1}),postMessage({event:"recorded"}),$("Recorded "+e.length+" line(s) of code.")}(n.data.lines);break;case"region":!async function(e){await W(`region(${e})`),postMessage({event:"regionSelected",index:e})}(n.data.index);break;case"stop":!async function(){u=!0,d.cancelWait(new Error("Stop")),g.write(t.encode("")),postMessage({event:"stopped"})}();break;case"eraseall_dms_execute_msg":!async function(){const e=i.getInfo();e.usbVendorId==v&&62209==e.usbProductId?(await g.write(new Uint8Array([250,15,199])),await S(200),postMessage({event:"eraseall_status_dms",value:2})):e.usbVendorId==v&&62208==e.usbProductId&&(await g.write(t.encode("\n")),await S(400),await g.write(t.encode("reset(1)\n")),await S(100),await g.write(t.encode("reset(1)\n")),await S(700),postMessage({event:"eraseall_status_dms",value:2}))}();break;case"eraseall_dms_connect_msg":!async function(e){E(`Port status ${s}`),await new Promise(e=>setTimeout(e,400)),[i]=await navigator.serial.getPorts();try{if(null==i)return;i.connected&&null!=i.readable&&null!=i.writable&&(i.readable.locked||i.writable.locked)&&(await I(),await new Promise(e=>setTimeout(e,1e3))),await i.open({baudRate:115200,dataBits:8,parity:"none",stopBits:1,flowControl:"none"})}catch(n){return postMessage({event:"ConnectFailed",message:n?.message,name:n.name,full:n}),void L(n?.message||"Unable to open port.")}if(i.addEventListener("disconnect",()=>{E("Port disconnected"),I()}),null==i?.writable)return void L("Port is not a writable.");if(null==i?.readable)return void L("Port is not a readable.");const a=i.getInfo();a.usbVendorId==v&&(g=i.writable.getWriter(),postMessage({event:"eraseall_vid_dms",value:a.usbVendorId<<16|a.usbProductId}));T=e,await g.write(t.encode(`sel(${T})\n`)),await S(50),await C(),postMessage({event:"eraseall_status_dms",value:1})}(n.data.value);break;case"driver_connect_msg":break;case"driver_connect_updadate_msg":!async function(){if(postMessage({event:"update_progress_percent_msg",value:0}),!s)return void postMessage({event:"update_progress_percent_msg",value:1});if(!y)return void postMessage({event:"update_progress_percent_msg",value:1});const e=k,a=await fetch(e);if(!a.ok)return void postMessage({event:"update_progress_percent_msg",value:1});let n=(await a.text()).replace(/\r/gm,"").replace(/\t/gm," ").split(/\n/);await W("new all"),postMessage({event:"update_progress_percent_msg",value:10}),await W("pgmbrst()","&"),await S(250),postMessage({event:"update_progress_percent_msg",value:20});let r=0;for(let t of n){await S(2),0===t.trim().length&&(t=" "),E("line",`"${t}"`),await D(t+"\n"),r++;let e=Math.floor(r/n.length*70);e>70&&(e=70),e+=20,postMessage({event:"update_progress_percent_msg",value:e})}postMessage({event:"update_progress_percent_msg",value:95}),await D("\0"),await U(),await g.write(t.encode("run\n")),await S(100),await g.write(t.encode("Region(1)\n")),await S(100),await C(),await g.write(t.encode("run\n")),await S(1e3),await g.write(t.encode("$\n")),await S(250),postMessage({event:"update_progress_percent_msg",value:96}),await g.write(t.encode("# This is region 1 User\n")),await S(250),await g.write(t.encode("# Replace this with your code\n")),await S(250),postMessage({event:"update_progress_percent_msg",value:97}),await g.write(t.encode("# StatLed(200,200,10)\n")),await S(250),postMessage({event:"update_progress_percent_msg",value:99}),await g.write(t.encode(">\n")),await S(250),await C(),postMessage({event:"update_progress_percent_msg",value:100})}();break;case"sendescape":!async function(){await g.write(t.encode("")),await S(400),await C()}();break;case"fn_load_sample":!async function(){if(!s)return void postMessage({event:"update_progress_percent_msg",value:1});const e=P,t=await fetch(e);if(postMessage({event:"update_progress_percent_msg",value:50}),!t.ok)return void postMessage({event:"update_progress_percent_msg",value:51});let a=await t.text();if(!(a?.length>0))return void postMessage({event:"update_progress_percent_msg",value:51});a="# The sample always assumes that the proper driver is installed.\n"+a,postMessage({event:"load_sample_result",value:a});await S(1e3),postMessage({event:"update_progress_percent_msg",value:100})}()}});let _=null;let f="",M="",b="",h="",y=!1,k="",P="",T=1,x="";async function I(){try{await async function(){o=!1,l&&(await c.cancel(),await l,l=null)}(),g&&(await g.close(),await g.releaseLock(),g=null),c&&(await c.cancel(),await c.releaseLock(),c=null),await i.close(),$("Port disconnected.")}catch(e){s&&($("There was an error while disconnecting."),L(e?.message||"Unknown error."))}finally{s=!1,postMessage({event:"disconnected"}),postMessage({event:"version",value:null}),M="",h="",k="",P="",x="",postMessage({event:"update_driver_path_msg",value:k}),postMessage({event:"driver_ver_msg",value:f}),postMessage({event:"device_name_msg",value:M}),postMessage({event:"sample_path_msg",value:P}),postMessage({event:"device_img_link_msg",value:x})}}async function R(){a=!0;const e=await W("mem()");postMessage({event:"memoryRegionsResult",result:e}),a=!1}function C(){return new Promise(async e=>{const t=[];let a;do{a=await d.tryPop(),a?(t.push(a),E("flushed - push line:",a)):E("flushed: No line")}while(a);t.length||(p=""),E("flushed",t),e(t)})}function E(){}function L(e){postMessage({event:"logError",message:e})}function $(e){postMessage({event:"logEvent",message:e})}let A=!1;function N(e,t){const a=[...e];return a.length>1?a.pop():a?.[0]===t&&a.shift(),A=!1,a}function U(e=null,t=3e3){return A?[]:(A=!0,e||(e=n),new Promise(async a=>{const s=[];let n=!1,r=null;const i=()=>{t<0||(clearTimeout(r),r=setTimeout(()=>{n=!0,m=!1,a(N(s,e))},t))};try{let t;i();do{try{t=await d.pop()}catch(o){return E("read until",o.message||o,s),clearTimeout(r),m=!1,void a(N(s,e))}if(!t||n)break;if(i(),s.push(t),t.startsWith("!")){E("Error:",t);break}}while(t!==e)}finally{clearTimeout(r)}m=!n,a(N(s,e))}))}function S(e){return new Promise(t=>setTimeout(t,e))}async function D(e){let a=t.encode(e),s=a.length,n=0;for(;s>0;){const e=a.subarray(n,n+Math.min(10,s));await g.write(e);const t=await d.tryPop();if(t)return t;n+=10,s-=e.length,await S(1)}return null}async function W(e,a=null,s="\n",r=3e3){try{postMessage({event:"isTalking",value:!0}),await C(),g.write(t.encode(e+s)),">"!==e&&"$"!==e||(n=e),await S(50);const i=await U(a||n,r);return i}finally{postMessage({event:"isTalking",value:!1,lastCommand:e})}}}();
